let express,cors,bodyParser,mongoose,nodemailer,url,Experts,Students,Admin,Date,major;_b5a‍.w("express",[["default",["express"],function(v){express=v}]]);_b5a‍.w("cors",[["default",["cors"],function(v){cors=v}]]);_b5a‍.w("body-parser",[["default",["bodyParser"],function(v){bodyParser=v}]]);_b5a‍.w("mongoose",[["default",["mongoose"],function(v){mongoose=v}],["Date",["Date"],function(v){Date=v}]]);_b5a‍.w("nodemailer",[["default",["nodemailer"],function(v){nodemailer=v}]]);_b5a‍.w("url",[["default",["url"],function(v){url=v}]]);_b5a‍.w("./Models/Experts",[["default",["Experts"],function(v){Experts=v}]]);_b5a‍.w("./Models/Students",[["default",["Students"],function(v){Students=v}]]);_b5a‍.w("./Models/Admin",[["default",["Admin"],function(v){Admin=v}]]);_b5a‍.w("semver",[["major",["major"],function(v){major=v}]]);



 









const app = express();
app.use(cors());
app.use(bodyParser.json());


// mongodb://localhost:27017/miras-egitim
mongoose.connect("mongodb+srv://dogukantopcu35:11Mart2003@cluster0.0fzxo.mongodb.net/?retryWrites=true&w=majority", {useNewUrlParser: true}, err => {
    if (err) throw err;
    console.log("Connected");
})


/*
    YENİ BİR ADMİN KAYDI İÇİN;
        ALTTAKİ KOD SATIRLARINI YORUMDAN ÇIKAR.
        NODE İLE SERVER.JS'İ ÇALIŞTIR.
        localhost:5555/createAdmin sayfasını aç.
*/

// app.get("/createAdmin", (req, res) => {
//     Admin.create({
//         username: "doguk",
//         password: "02584560"
//     }, err => {
//         if (err) res.sendStatus(400);
//         res.sendStatus(200);
//     })
// });



app.post("/adminLogin", (req, res) => {
    const {username, password} = req.body;
    Admin.findOne({username: username, password: password}).then((doc) => {
        res.send(doc);
    }).catch(err => {
        _b5a‍.g.console.log(err);
    })
})

app.post("/userLogin", (req, res) => {
    const { email, password } = req.body;

    Students.findOne({email: email, password: password}).then((doc) => {
        res.send(doc);
    }).catch(err => {
        _b5a‍.g.console.log(err);
    });

})




app.post("/sendVerificationMail", (req, res) => {
    _b5a‍.g.console.log(req.body);
    _b5a‍.g.console.log(req.body.email);
    _b5a‍.g.console.log(req.body.manner);


    if (req.body.manner == "searcher") {
        Students.findOne({email: req.body.email, fullName: req.body.userName}).then(doc => {
            // console.log(doc);
            _b5a‍.g.console.log(doc.verifiedCode);

            var transfer = nodemailer.createTransport({
                service: "hotmail",
                auth:{
                    user: "dogukan_topcu35@hotmail.com",
                    pass: "dT={11.03.2003}"
                }
            });
        
            var mailInfo = {
                from: "dogukan_topcu35@hotmail.com",
                to: req.body.email,
                subject: "Send a mail with NodeJs",
                text: "My first mail sent with NodeJs.",
                html: `
                    <h1>Doğrulama Kodu</h1>
                    <h2>${doc.verifiedCode}</h2>
                    <h4>${doc.fullName} lütfen aşağıdaki linke tıklayarak mailinizi onaylayınız.</h4>
                    <a href="http://localhost:3005/verified?email=${doc.email}&verifiedCode=${doc.verifiedCode}">ONAYLA</a>
                `
            };
        
            transfer.sendMail(mailInfo, (err) => {
                if (err) _b5a‍.g.console.log(err);
                else {
                    console.log("Your mail was sent.");
                };
            });
        });
    }

    if (req.body.manner == "advisor") {
        Experts.findOne({email: req.body.email, fullName: req.body.userName}).then(doc => {
            _b5a‍.g.console.log(doc.verifiedCode);

            var transfer = nodemailer.createTransport({
                service: "hotmail",
                auth:{
                    user: "dogukan_topcu35@hotmail.com",
                    pass: "dT={11.03.2003}"
                }
            });
        
            var mailInfo = {
                from: "dogukan_topcu35@hotmail.com",
                to: req.body.email,
                subject: "Send a mail with NodeJs",
                text: "My first mail sent with NodeJs.",
                html: `
                    <h1>Doğrulama Kodu</h1>
                    <h2>${doc.verifiedCode}</h2>
                    <h4>${doc.fullName} lütfen aşağıdaki linke tıklayarak mailinizi onaylayınız.</h4>
                    <a href="http://localhost:3005/verified?email=${doc.email}&verifiedCode=${doc.verifiedCode}">ONAYLA</a>
                `
            };
        
            transfer.sendMail(mailInfo, (err) => {
                if (err) _b5a‍.g.console.log(err);
                else {
                    console.log("Your mail was sent.");
                };
            });
        });
    }

});

app.get("/verified", (req, res) => {
    _b5a‍.g.console.log(req.query);
    _b5a‍.g.console.log(req.query.email);
    _b5a‍.g.console.log(req.query.verifiedCode);

    var q = {
        email: req.query.email.toString(),
        verifiedCode: req.query.verifiedCode
    }
    
    Students.updateOne(q, {$set:{verified: true}}, (err, docs) => {
        if (err) throw err;
        _b5a‍.g.console.log(docs);
        console.log("Updated");
        if (docs.modifiedCount == 1) {
            res.sendFile(__dirname + "/Views/verification.html");
        }
    });
    
    Experts.updateOne(q, {$set:{verified: true}}, (err, docs) => {
        if (err) throw err;
        _b5a‍.g.console.log(docs);
        console.log("Updated");
        if (docs.modifiedCount == 1) {
            res.sendFile(__dirname + "/Views/verification.html");
        }
    });

})




app.post("/saveUser", (req, res) => {
    _b5a‍.g.console.log(req.body);

    const {email, password, fullName, city, manner, major, image, verified, desc, verifiedCode} = req.body.user;

    _b5a‍.g.console.log(email, password, fullName, city, manner, image, verified, verifiedCode);

    if (manner == "searcher") {

        console.log("inside");
        Students.create({
            email: email,
            password: password,
            fullName: fullName,
            city: city,
            verified: verified,
            verifiedCode: verifiedCode,
            image: image,


        }, err => {
            if (err) res.sendStatus(400);
            res.sendStatus(200);
        })
    }

    if (manner == "advisor") {
        Experts.create({
            email: email,
            password: password,
            fullName: fullName,
            
            city: city,
            desc: desc,
            major: major,

            verified: verified,
            verifiedCode: verifiedCode,


            image: image,
            isVipOfWeek: false,
            isVip: false,

            // signedDate: Date.now,
            // verifiedDate: Date.now,

            // weeklyVipDate: Date,
            // vipDate: Date,
            weeklyVipNumber: 0,
            vipNumber: 0,

        }, err => {
            if (err) res.sendStatus(400);
            res.sendStatus(200);
        })
    }
})




app.post("/sendNewPass", (req, res) => {
    _b5a‍.g.console.log(req.body)
    const email = req.body.email;
    const password = req.body.password;

    Students.updateOne({email: email}, {$set: {password: password}}, (err, docs) => {
        if (err) throw err;
        console.log("Updated");

        if (docs.modifiedCount == 1) {
            res.send("Success");

            var transfer = nodemailer.createTransport({
                service: "hotmail",
                auth:{
                    user: "dogukan_topcu35@hotmail.com",
                    pass: "dT={11.03.2003}"
                }
            });
        
            var mailInfo = {
                from: "dogukan_topcu35@hotmail.com",
                to: email,
                subject: "Yeni Şifre",
                text: "Miras Eğitim",
                html: `
                    <h1>Doğrulama Kodu</h1>
                    <h2>${password}</h2>
                    <h4>Yeni şifreniz.</h4>
                    <a href="http://localhost:3000/giris-yap">Giriş Yap</a>
                `
            };
        
            transfer.sendMail(mailInfo, (err) => {
                if (err) _b5a‍.g.console.log(err);
                else {
                    console.log("Your mail was sent.");
                };
            });


        }

        if (docs.modifiedCount == 0) {
            Experts.updateOne({email: email}, {$set: {password: password}}, (err, docs) => {
        if (err) throw err;
        console.log("Updated");

        if (docs.modifiedCount == 1) {
            res.send("Success");

            var transfer = nodemailer.createTransport({
                service: "hotmail",
                auth:{
                    user: "dogukan_topcu35@hotmail.com",
                    pass: "dT={11.03.2003}"
                }
            });
        
            var mailInfo = {
                from: "dogukan_topcu35@hotmail.com",
                to: email,
                subject: "Yeni Şifre",
                text: "Miras Eğitim",
                html: `
                    <h1>Doğrulama Kodu</h1>
                    <h2>${password}</h2>
                    <h4>Yeni şifreniz.</h4>
                    <a href="http://localhost:3000/giris-yap">Giriş Yap</a>
                `
            };
        
            transfer.sendMail(mailInfo, (err) => {
                if (err) _b5a‍.g.console.log(err);
                else {
                    console.log("Your mail was sent.");
                };
            });


        }

        if (docs.modifiedCount == 0) {
            res.send("Undefined");
        }
    })
            res.send("Undefined");
        }
    })

    
})





// **********************************************************************************

// Get Proccess


// ---------Login----Register----------------
app.get("/getUserEmails", (req, res) => {
    Students.find({}).then((doc) => {
        res.send(doc);
    }).catch(err => _b5a‍.g.console.log(err));
});

app.get("/getExpertsEmails", (req, res) => {
    Experts.find({}).then((doc) => {
        res.send(doc);
    }).catch(err => _b5a‍.g.console.log(err));
});



// -------Admin Panel--------------

app.get("/students", (req, res) => {
    Students.find({}).then((doc) => {
        res.send(doc);
    }).catch(err => _b5a‍.g.console.log(err));
});

app.get("/experts", (req, res) => {
    Experts.find({}).then((doc) => {
        res.send(doc);
    }).catch(err => _b5a‍.g.console.log(err));
});

app.get("/vipExperts", (req, res) => {
    Experts.find({isVip: true}).then((doc) => {
        res.send(doc);
    }).catch(err => _b5a‍.g.console.log(err));
});

app.get("/vipOfWeek", (req, res) => {
    Experts.find({isVipOfWeek: true}).then((doc) => {
        res.send(doc);
    }).catch(err => _b5a‍.g.console.log(err));
});

app.get("/admins", (req, res) => {
    Admin.find({}).then((doc) => {
        res.send(doc);
    }).catch(err => _b5a‍.g.console.log(err));
});


app.listen(3005);